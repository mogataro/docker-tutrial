<!DOCTYPE html>
<html>

<body>

  <h1>Dockerコンテナの実行</h1>

  <p>この記事はUdemyの<a href="https://www.udemy.com/course/docker-k/" target="_blank">「ゼロからはじめる
      Dockerによるアプリケーション実行環境構築」</a>受講時の個人的なメモ書きです。</p>

  <h2>hello-worldコンテナの実行と動作の解説</h2>

  <p>ターミナルから以下のコマンドを実行する</p>
  <pre>
    <code>
      docker run hello-world
    </code>
  </pre>

  <p>dockerの部分はdockerコマンドで、runはその後ろに記述されたイメージを取得してイメージからコンテナを起動するサブコマンドです。</p>
  <p>このコマンドの場合はhello-worldというイメージを取得してコンテナを起動します。</p>
  <P>docker run hello-worldと打つとDockerコマンドはDockerデーモンに接続してhello-worldのイメージを探します。<br />
    最初はhello-worldのイメージはPC上には存在しないのでインターネットを経由して、Docker HubというDocker社がホスティングしているサーバーに探しに行きます。<br />
    Docker Hub上にhello-worldイメージが見つかったらイメージをダウンロードしてPC上に保存します。<br />
    保存したイメージを基にコンテナを起動してコンテナに定義されたコマンドを実行します。<br />
    実行結果は最終的にDockerクライアントに送られターミナルの画面に表示されます。<br />
    同じイメージがPC上に存在する場合はPC上に存在するイメージからコンテナを起動するのでもっと早く処理が終わります。
  </P>

  <p>
    <code>docker run</code>コマンドは複数のDockerコマンドをまとめて実行したのと同じ意味があります。<br />
    イメージがPCに存在しない場合にDocker Hubにイメージを取得しに行った部分は<code>docker pull</code>コマンドが同じことが行えます。<br />
    コンテナ作成のみを行う部分は<code>docker create</code>コマンドがあり、<br />
    コンテナを起動するコマンドに<code>docker start</code>コマンドがあります。
  </p>

  <h2>Docker Hubとは</h2>

  <p>Docker HubとはDockerイメージのレジストリサービスでDocker Hubを経由してDockerイメージの公開 検索ダウンロードを行うことができます。</p>
  <p>
    Docker Hubのurlは<a src="https://hub.docker.com" target="_blank">https://hub.docker.com</a>です。
  </p>
  <p>Docker Hubにアカウントを作成しておく事で自身で作成したイメージを公開することもできます。</p>
  <p>Docker Hubに上がってるイメージにはオフィシャルのものと 個人や組織で独自に公開しているものがあります。<br />
    イメージ名がスラッシュで区切られていないものがオフィシャルのイメージです。<br />
    スラッシュで区切られているものはスラッシュより前に個人や組織名が入っておりスラッシュの後にイメージ名がつながっている形になっています。<br />
    オフィシャルなイメージはDocker社によってレビューが行われておりセキュリティ的な面やイメージサイズなどの面でチェックが入っています。<br />
    また、オフィシャルなリポジトリの場合リポジトリ詳細ページの上にOFFICIAL REPOSITORYと記載されています。<br />
  </p>
  <p>
    詳細ページのTagsタブにはリポジトリに含まれるイメージがタグ付けされて管理されています。<br />
    <code>docker run hello-world</code>のように使用するイメージ名のみ指定していた場合は自動的にhello-worldのリポジトリのlatestタグのイメージがダウンロードされます。<br />
    明示的にイメージタグを指定してコンテナを実行する場合は<code>docker run hello-world:latest</code>のように、イメージ名をコロンで区切ってタグ名を指定します。
  </p>

  <h2>Dockerイメージとは</h2>

  <p>Dockerイメージとは特定のコンテナを実行するのに必要なファイルをまとめたファイルシステムです。<br />
    一般的にイメージに含まれるものとしてOSのライブラリやアプリケーションなどがあります。<br />
    例えばwebサーバーのコンテナを作る場合にはnginxやApacheが既にインストールされているイメージが使用できます。<br />
    プログラムの実行環境についても同様でPHPやRubyの実行環境が欲しい場合はこれらのイメージからコンテナを作成すれば簡単に実行環境を用意することができます。
  </p>

  <p>
    必ずしも最初から必要なソフトウェアが含まれるイメージを用意する必要はなく自身で作成することもできます。<br />
    イメージのファイルシステムに使用されるストレージドライバーとしてはAUFSなどが挙げられレイヤーという階層構造でデータが管理される少々特殊なファイルシステムとなっています。<br />
    そしてイメージのデータはレイヤーで構成され全て読み取り専用で編集することはできない作りになっています。
  </p>

  <h3>Dockerイメージのファイルシステム</h3>

  <div>
    <img src="img/docker_002.png" alt="Dockerイメージのファイルシステムの図" title="Dockerイメージのファイルシステム">
  </div>

  <p>
    左の図はDockerイメージの図で右がそのイメージから作成したコンテナの図です。<br />
    イメージは階層構造でデータが管理されており各層のことをレイヤーと呼びます。<br />
    Dockerのイメージのレイヤーは一種のコマンドを実行するたびに階層が積み重ねられていきます。<br />
    例えばDockerイメージにnginxをインストールするコマンドを実行すればそれが一つの階層として作られ、<br />
    設定ファイルはイメージ内にコピーした場合にさらにもうひとつの階層が作られるようなイメージです。<br />
    なお、一度作成したイメージのレイヤーは全て読み取り専用となっており変更を加えることはできません。
  </p>

  <p>
    右の図は、Dockerイメージを基にコンテナを起動すると新たに新しく読み書き可能なコンテナレイヤーという層が作られます。<br />
    dockerイメージからコンテナを起動してコンテナレイヤー上にファイルの追加や削除やパッケージの追加など行い、それをまたイメージとして保存することも可能です。
  </p>

  <p>
    注意すべき点は、過去のレイヤーで追加したファイルをコンテナレイヤーで削除して新しいイメージを作成したとしても過去のレイヤーからファイルが消えないことです。<br />
    削除を実行したコンテナレイヤー上で削除コマンドが実行されファイルが削除されますが、履歴として過去のレイヤーには残り続けるのであるレイヤーでファイルを追加した処理はそのまま残り続けます。<br />
    よって一度大きなファイルを追加してイメージ化したものをあとのレイヤーで削除したとしてもイメージにはその大きなファイルは残り続けるのでイメージ全体のサイズは変わることはありません。<br />
    Dockerコンテナはなるべく軽量にサイズを抑えることが重要とされているため、無駄なファイルがイメージの中に含まれないようにイメージを作成することが大事です。<br />
    Dockerイメージが大きくなるということはイメージのダウンロードやDocker Hubへのアップロードに時間がかかるようになります。
  </p>


  <h3>Dockerイメージの継承</h3>

  <p>
    Dockerイメージの特徴として複数のイメージで継承関係を作ることができるという点があります。
  </p>

  <div>
    <img src="img/docker_003.png" alt="Dockerのイメージ継承の図1" title="Dockerのイメージ継承 その1">
  </div>

  <p>
    この例はベースイメージとしてCent OSのベースイメージを使用してRubyの実行環境のイメージを作成する場合です。<br />
    ベースイメージとは何も継承していない起点となるDockerイメージのことを言います。<br />
    このようにCent OSのイメージに追加した形でRubyの実行環境をインストールしたイメージを作ることができます。
  </p>

  <div>
    <img src="img/docker_004.png" alt="Dockerのイメージ継承の図2" title="Dockerのイメージ継承 その2">
  </div>

  <p>
    これは先ほどのRubyの実行環境を持ったイメージを継承しRubyのフレームワークであるRailsのレイヤーを加えた例です。<br />
    Dockerイメージはうまく使っていくことでベースイメージから機能別にイメージを構築し、最終的にアプリケーションのレイヤーを加えていくことができます。
  </p>

  <h3>同じイメージを継承した場合のメリット</h3>

  <div>
    <img src="img/docker_005.png" alt="同じDockerイメージを継承するメリットの図" title="同じDockerイメージを継承するメリット">
  </div>

  <p>
    同じCent OSのイメージを継承したRubyの実行環境のイメージとMySQLのイメージがあるとします。<br />
    互いに同じイメージを利用している場合全く同じレイヤーの部分については同じレイヤーのデータを参照します。<br />
    こちらの場合はCent OSのイメージに含まれるレイヤーはひとつしか持たずRubyのイメージとMySQLのイメージで共有してCent OSのイメージを使用するということです。<br />
    これにより使用するイメージサイズが小さくなりストレージの節約につながります。<br />
    また２重にレイヤーのデータを用意する必要がなくなるので既にCent OSのイメージが存在する場合はサブのRubyのレイヤーやMySQLのレイヤーだけ取得すればよくイメージ取得の通信料も抑えることができます。
  </p>

  <h2>whalesayコンテナの実行とDockerイメージダウンロードの動作</h2>

  <h3>halesayコンテナの実行</h3>

  <p>whalesayイメージはDocker社が作成したイメージでクジラのアスキーアートに好きな言葉を喋らせることができるチュートリアル用のイメージです。</p>

  <pre><code>$ docker run docker/whalesay cowsay hellow!</code></pre>

  <p>
    イメージ名は<code>docker/whalesay</code>で、タグ名は指定していないのでlatestタグが使用されます。<br />
    <code>cowsay hello!</code>の部分はwhalesayコンテナの内部で実行するコマンドです。<br />
    このようにイメージの後ろにコマンドを繋げることでコンテナが立ち上がった後にコマンドを実行することができます。<br />
    コマンドを渡した際の動作はイメージの作られ方によって微妙に異なります。<br />
    cowsayというプログラムはもともと牛のアスキーアートに吹き出しをつけて好きな言葉をしゃべらせて遊べるアプリケーションで、それをクジラのアスキーアートに改良したものがこのイメージに入っています。
  </p>

  <p>whalesayコンテナの実行結果</p>
  <div>
    <img src="img/docker_006.png" alt="whalesayコンテナの実行結果のスクリーンショット" title="whalesayコンテナの実行結果">
  </div>

  <p>
    <code>Unable to find image</code>という部分は今回指定しているdocker/whalesayのlatestタグのイメージがローカルに存在しないことを表しています。<br />
    <code>latest: Pulling from docker/whalesay</code>の部分はlatestタグのイメージをdocker/whalesayリポジトリからPull(イメージを取得)しているということを表しています。<br />
    <code>e190868d63f8: Pull complete</code>などのランダムな文字列と<code>Pull complete</code>と記載された各行については、docker/whalesayイメージの各レイヤーと取得状況のことです。<br />
    もし対象のイメージを持っていない場合でも一部ローカルにそのイメージのレイヤー情報を持っている場合は足りないレイヤーだけがダウンロードされます。<br />
    取得しようとしているイメージが他のイメージと共通する親イメージを継承していた場合などに部分的にローカルにレイヤーが取得済みである場合があります。<br />
    今回はwhalesayイメージで使用されているレイヤーの中で取得済みのレイヤーはないので全てダウンロードされます。<br />
    <code>Digest:</code>と記載されている部分はイメージのデータをsha256でハッシュ化したもので、イメージごとに一意となる値で、イメージの内容が変更された場合はこの値も変わります。<br />
    <code>Status:</code>と記載されている部分はイメージのPullの結果がどうなったかを表すメッセージが表示されます。<br />
    これらのメッセージの後にダウンロードしたイメージからコンテナが作成されdocker runコマンドに渡した<code>cowsay Hello!</code>のコマンドが実行され、コマンドの結果が表示されます。
  </p>

  <h3>ローカルにダウンロード済みのイメージ一覧を表示するコマンド</h3>

  <p><code>$ docker images</code>と打つとイメージ一覧を表示できます。</p>

  <pre><code>
    $ docker images
    REPOSITORY        TAG       IMAGE ID       CREATED       SIZE
    docker/whalesay   latest    6b362a9f73eb   6 years ago   247MB
  </code></pre>

  <h3>イメージのタグ付けコマンド</h3>

  <p>イメージは<code>docker tag</code>コマンドを使用することで任意のイメージ名でタグ付けすることができます。</p>

  <p>
    <code>$ docker tag {元となるイメージ名} {新しいイメージ名}:{タグ名}</code>
  </p>

  <pre><code>
    $ docker tag docker/whalesay my_whalesay
    $ docker images
    REPOSITORY        TAG       IMAGE ID       CREATED       SIZE
    docker/whalesay   latest    6b362a9f73eb   6 years ago   247MB
    my_whalesay       latest    6b362a9f73eb   6 years ago   247MB
  </code></pre>

  <p>
    タグ付けと言いましたが、イメージ名も指定することができます。
    これはエイリアスのようなもので新しくタグ付けされたイメージは元のイメージと全く同じイメージを指します。<br />
    MAGE IDは変わっていないことが確認できます。
  </p>

  <p>
    タグをつけていないためにlatestタグになっています。<br />
    タグをつける場合は、新しいイメージ名の後にコロンで区切ってタグ名を書いて実行するだけです。
  </p>

  <pre><code>
    $ docker tag docker/whalesay my_whalesay:ver1
    $ docker images
    REPOSITORY        TAG       IMAGE ID       CREATED       SIZE
    docker/whalesay   latest    6b362a9f73eb   6 years ago   247MB
    my_whalesay       latest    6b362a9f73eb   6 years ago   247MB
    my_whalesay       ver1      6b362a9f73eb   6 years ago   247MB
  </code></pre>

  <h3>イメージの詳細情報を表示するコマンド</h3>

  <p>イメージの詳細情報を表示するには<code>docker inspect</code>コマンドを使用します。</p>

  <p>
    <code>$ docker inspect {対象になるイメージ名 or イメージID}</code>
  </p>

  <pre><code>
    $ docker inspect my_whalesay

    [
      {
        "Id": "sha256:6b362a9f73eb8c33b48c95f4fcce1b6637fc25646728cf7fb0679b2da273c3f4",
        "RepoTags": [
          "docker/whalesay:latest",
          "my_whalesay:latest",
          "my_whalesay:ver1"
        ],
        "RepoDigests": [
          "docker/whalesay@sha256:178598e51a26abbc958b8a2e48825c90bc22e641de3d31e18aaf55f3258ba93b"
        ],
        "Parent": "",
        "Comment": "",
        "Created": "2015-05-25T22:04:23.303454458Z",
        "Container": "5460b2353ce4e2b3e3e81b4a523a61c5adc238ae21d3ec3a5774674652e6317f",
        "ContainerConfig": {
          "Hostname": "9ec8c01a6a48",
          "Domainname": "",
          "User": "",
          "AttachStdin": false,
          "AttachStdout": false,
          "AttachStderr": false,
          "Tty": false,
          "OpenStdin": false,
          "StdinOnce": false,
          "Env": [
              "PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          ],
          "Cmd": [
              "/bin/sh",
              "-c",
              "#(nop) ENV PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          ],
          "Image": "5d5bd9951e26ca0301423625b19764bda914ae39c3f2bfd6f1824bf5354d10ee",
          "Volumes": null,
          "WorkingDir": "/cowsay",
          "Entrypoint": null,
          "OnBuild": [],
          "Labels": {}
        },
        "DockerVersion": "1.6.0",
        "Author": "",
        "Config": {
          "Hostname": "9ec8c01a6a48",
          "Domainname": "",
          "User": "",
          "AttachStdin": false,
          "AttachStdout": false,
          "AttachStderr": false,
          "Tty": false,
          "OpenStdin": false,
          "StdinOnce": false,
          "Env": [
              "PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
          ],
          "Cmd": [
              "/bin/bash"
          ],
          "Image": "5d5bd9951e26ca0301423625b19764bda914ae39c3f2bfd6f1824bf5354d10ee",
          "Volumes": null,
          "WorkingDir": "/cowsay",
          "Entrypoint": null,
          "OnBuild": [],
          "Labels": {}
        },
        "Architecture": "amd64",
        "Os": "linux",
        "Size": 247049019,
        "VirtualSize": 247049019,
        "GraphDriver": {
          "Data": {
              "LowerDir": "/var/lib/docker/overlay2/3f3b4c6143c3af55053677ce08ce90ee7c290c5394ee4ff31e8b2c430ac3e09c/diff:/var/lib/docker/overlay2/884e98d621b9bdaf14d854f7929e8317fe166961af1f141bfdf51d82e9897004/diff:/var/lib/docker/overlay2/b48cf5ba8dc6529ac5eac9ac4e012310fc82e0719e0e2372e63b35ebbe38e9bc/diff:/var/lib/docker/overlay2/adaf288ea3f243848d4f8b44054e5524acda81f600f4b61185cf6c5b9b2069a0/diff:/var/lib/docker/overlay2/6ec282559be2a8040bdd109264c87a6049edccb13670e9809491161738d66a5e/diff:/var/lib/docker/overlay2/4c4f3423775701b38d98f4736ade7ae1d45d8d5fbfd4f56b007ca219155bfe61/diff:/var/lib/docker/overlay2/7cf5e8f2655cf6dda57d6f7bb73b935bffacff54453a50c5c12c6556c261f2b9/diff:/var/lib/docker/overlay2/bbaa864b8f7dbedae04adb34643b65e33ab3b22135f22e637e03555f04b7ce87/diff:/var/lib/docker/overlay2/5d4f62398fe76f263e6646f5b2ff31bf5c8140f6bad45b7527c444a9abaeedfb/diff",
              "MergedDir": "/var/lib/docker/overlay2/cffb1e0d92f52559b879bee1912707f4c3d672f2dc5374e4b051432d69ead661/merged",
              "UpperDir": "/var/lib/docker/overlay2/cffb1e0d92f52559b879bee1912707f4c3d672f2dc5374e4b051432d69ead661/diff",
              "WorkDir": "/var/lib/docker/overlay2/cffb1e0d92f52559b879bee1912707f4c3d672f2dc5374e4b051432d69ead661/work"
          },
          "Name": "overlay2"
        },
        "RootFS": {
          "Type": "layers",
          "Layers": [
              "sha256:1154ba695078d29ea6c4e1adb55c463959cd77509adf09710e2315827d66271a",
              "sha256:528c8710fd95f61d40b8bb8a549fa8dfa737d9b9c7c7b2ae55f745c972dddacd",
              "sha256:37ee47034d9b78f10f0c5ce3a25e6b6e58997fcadaf5f896c603a10c5f35fb31",
              "sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef",
              "sha256:b26122d57afa5c4a2dc8db3f986410805bc8792af3a4fa73cfde5eed0a8e5b6d",
              "sha256:091abc5148e4d32cecb5522067509d7ffc1e8ac272ff75d2775138639a6c50ca",
              "sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef",
              "sha256:d511ed9e12e17ab4bfc3e80ed7ce86d4aac82769b42f42b753a338ed9b8a566d",
              "sha256:d061ee1340ecc8d03ca25e6ca7f7502275f558764c1ab46bd1f37854c74c5b3f",
              "sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef"
          ]
        },
        "Metadata": {
          "LastTagTime": "2021-12-04T04:29:01.6633711Z"
        }
      }
    ]
  </code></pre>

  <p>表示された情報の中にはdockerコンテナの設定情報として「ホスト名」「環境変数」「コンテナ起動時に実行されるコマンド」「コマンド実行時のディレクトリの情報」などがあります。<br />
    その他にもOSの情報やサイズ、ファイルシステムの情報なども表示されています。
  </p>

  <h3>Dockerイメージを削除コマンド</h3>

  <p>Dockerイメージを削除するには<code>docker rmi</code>コマンドを使用します。</p>

  <p>
    <code>$ docker rmi {対象になるイメージ名 or イメージID}:{タグ名}</code>
  </p>

  <p>
    削除対象はイメージ名かイメージIDで指定しますが、すでにそのイメージを使用して作られたコンテナが存在する場合は、コンテナを削除してからイメージを削除するか、強制削除のフラグである<code>-f</code>をつける必要があります。
  </p>

  <pre><code>
    $ docker rmi docker/whalesay
    Untagged: docker/whalesay:latest
    Untagged: docker/whalesay@sha256:178598e51a26abbc958b8a2e48825c90bc22e641de3d31e18aaf55f3258ba93b
    
    $ docker images
    REPOSITORY    TAG       IMAGE ID       CREATED       SIZE
    my_whalesay   latest    6b362a9f73eb   6 years ago   247MB
    my_whalesay   ver1      6b362a9f73eb   6 years ago   247MB
  </code></pre>

  <p>docker/whalesayのlatestタグのイメージが一覧からなくなっています。<br />
    イメージの削除もタグ名を付けなければlatestタグのものが削除されます。
  </p>

  <h3>イメージを取得するコマンド</h3>

  <p>
    <code>$ docker pull {対象になるイメージ名}:{タグ名}</code>
  </p>

  <pre><code>
    $ docker pull docker/whalesay

    Using default tag: latest
    latest: Pulling from docker/whalesay
    Image docker.io/docker/whalesay:latest uses outdated schema1 manifest format. Please upgrade to a schema2 image for better future compatibility. More information at https://docs.docker.com/registry/spec/deprecated-schema-v1/
    e190868d63f8: Already exists 
    909cd34c6fd7: Already exists 
    0b9bfabab7c1: Already exists 
    a3ed95caeb02: Already exists 
    00bf65475aba: Already exists 
    c57b6bcc83e3: Already exists 
    8978f6879e2f: Already exists 
    8eed3712d2cf: Already exists 
    Digest: sha256:178598e51a26abbc958b8a2e48825c90bc22e641de3d31e18aaf55f3258ba93b
    Status: Downloaded newer image for docker/whalesay:latest
    docker.io/docker/whalesay:latest

    $ docker images
    REPOSITORY        TAG       IMAGE ID       CREATED       SIZE
    my_whalesay       latest    6b362a9f73eb   6 years ago   247MB
    my_whalesay       ver1      6b362a9f73eb   6 years ago   247MB
    docker/whalesay   latest    6b362a9f73eb   6 years ago   247MB
  </code></pre>

  <p>先ほど削除したdocker/whalesayイメージが復活していることが確認できます。<br />
    docker/whalesayイメージをPullした際にイメージの全てのレイヤーが「Already
    exsists」になっているのは、「my_whalesay」という名前で「docker/whalesay」と全く同じレイヤーを持つイメージがローカルに存在するためです。
  </p>

  <h2>Dockerfileを使用したイメージビルドの方法</h2>

  <p>イメージを構築するにはDockerファイルというイメージの定義ファイルを作成します。<br />
    Dockerファイルからイメージを構築することをイメージビルドといいます。</p>





</body>

</html>